#!/bin/bash
#
# a script to monitor log files generated by GemFire builds.
# A bg process does a tail-f on the most recently written file.
# If a more recent log file is noticed, the current tail is stopped
# and a new one is started.
#

hn=`hostname`
function setlabel {
  echo "^[]2; ${hn} [$$]"
}

taildir=${1:-.}
file=`ls -t $taildir/*.log $taildir/*.txt $taildir/*.out $taildir/gemfire*/*.log 2>/dev/null | head -n 1`
curfile=$file
echo "----- $file -----"
echo "]2; $file "
sleep 1

tail -f $file&
proc=$!
trap "kill $proc; setlabel" EXIT
while [ 1 ]; do
    sleep 5
    file=`ls -t $taildir/*.log $taildir/*.txt $taildir/*.out $taildir/gemfire*/*.log 2>/dev/null | head -n 1`
    if [ x"$file" != x"$curfile" ]; then
        kill $proc
        clear
        echo "----- $file -----"
        echo "]2; $file "
        sleep 1
        curfile=$file
        tail -f $file&
        proc=$!
        trap "kill $proc; setlabel" EXIT
    fi
done
